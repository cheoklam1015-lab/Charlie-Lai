<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極簡數獨 Sudoku</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #34495e;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #f0f3f6;
            --grid-border: #95a5a6;
            --cell-bg: #ffffff;
            --cell-selected: #e8f4fd;
            --cell-same: #d5f5e3;
            --cell-highlight: #f7f9fa;
            --text-color: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Microsoft JhengHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-top: 10px;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        /* 難度選擇器 */
        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .difficulty-btn {
            padding: 8px 20px;
            font-size: 0.95rem;
            border: 1px solid var(--accent-color);
            background-color: white;
            color: var(--accent-color);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .difficulty-btn.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        
        .difficulty-btn:hover:not(.active) {
            background-color: #f0f7ff;
        }
        
        /* 控制區 */
        .game-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .timer-badge {
            background: var(--primary-color);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            text-decoration: none; /* 為了 a 標籤 */
        }
        
        .btn:active { transform: translateY(1px); }
        
        .btn-new { background-color: var(--success-color); }
        .btn-check { background-color: var(--accent-color); }
        .btn-hint { background-color: var(--warning-color); }
        .btn-home { background-color: #95a5a6; }
        
        /* 數獨網格核心樣式 */
        .sudoku-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            /* --- 修正重點：明確定義列高為 1fr，確保空行高度一致 --- */
            grid-template-rows: repeat(9, 1fr);
            /* ---------------------------------------------- */
            gap: 1px;
            background-color: #ccc; /* 細線條顏色 */
            border: 3px solid #333; /* 外框粗線 */
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1; /* 保持整個網格為正方形 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .sudoku-cell {
            background-color: var(--cell-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 4vw, 24px); /* 響應式字體大小 */
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s;
            position: relative;
            /* 確保格子填滿網格區域 */
            width: 100%;
            height: 100%;
        }
        
        /* 3x3 宮格粗線條 (CSS Grid Hack) */
        /* 右側粗線 (第3, 6列) */
        .sudoku-cell:nth-child(3n) {
            border-right: 2px solid #333;
        }
        /* 修正最後一列不需要粗線 */
        .sudoku-cell:nth-child(9n) {
            border-right: none;
        }
        /* 底部粗線 (第19-27, 46-54行) */
        .sudoku-cell:nth-child(n+19):nth-child(-n+27),
        .sudoku-cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #333;
        }
        
        /* 狀態樣式 */
        .sudoku-cell.selected {
            background-color: var(--accent-color);
            color: white !important;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
        
        .sudoku-cell.default {
            color: #000;
            font-weight: 700;
            background-color: #fafafa;
        }
        
        .sudoku-cell.user {
            color: var(--accent-color);
        }
        
        .sudoku-cell.error {
            background-color: #fadbd8 !important;
            color: var(--danger-color) !important;
        }
        
        .sudoku-cell.highlight {
            background-color: var(--cell-highlight);
        }
        
        .sudoku-cell.same-number {
            background-color: var(--cell-same);
        }
        
        /* 數字輸入面板 */
        .numpad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-width: 450px;
            margin: 0 auto 20px auto;
            width: 100%;
        }
        
        .num-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            height: 50px;
            font-size: 1.4rem;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .num-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: #f0f8ff;
        }
        
        .num-btn.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }

        .num-btn-clear {
            color: var(--danger-color);
            font-size: 1.2rem;
        }
        
        /* 訊息框 */
        .message-box {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95rem;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .message-box.success { background: #e8f5e9; color: var(--success-color); border-left: 5px solid var(--success-color); }
        .message-box.error { background: #ffebee; color: var(--danger-color); border-left: 5px solid var(--danger-color); }
        .message-box.info { background: #e3f2fd; color: var(--accent-color); border-left: 5px solid var(--accent-color); }

        /* 狀態統計 */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .stat-item b { color: var(--text-color); font-size: 1.1rem; margin-left: 5px; }

        /* RWD */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8rem; }
            .game-controls { justify-content: center; }
            .actions { justify-content: center; width: 100%; }
            .btn { flex: 1; justify-content: center; padding: 10px; font-size: 0.85rem; }
            .sudoku-grid { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-border-all"></i> 數獨 Sudoku</h1>
            <p class="subtitle">填滿數字，完成邏輯挑戰</p>
            
            <div class="difficulty-selector">
                <button class="difficulty-btn active" data-diff="easy">簡單</button>
                <button class="difficulty-btn" data-diff="normal">中等</button>
                <button class="difficulty-btn" data-diff="hard">困難</button>
            </div>
        </header>
        
        <div class="game-controls">
            <div class="timer-badge">
                <i class="far fa-clock"></i> <span id="timer">00:00</span>
            </div>
            <div class="actions">
                <button class="btn btn-new" id="newGameBtn"><i class="fas fa-redo"></i> 新遊戲</button>
                <button class="btn btn-check" id="checkBtn"><i class="fas fa-check-circle"></i> 檢查</button>
                <button class="btn btn-hint" id="hintBtn"><i class="fas fa-lightbulb"></i> 提示</button>
                <!-- 修正：使用正確的 a 標籤結構 -->
                <a href="index.html" class="btn btn-home"><i class="fas fa-home"></i> 返回</a>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">錯誤: <b id="errorCount">0</b></div>
            <div class="stat-item">提示: <b id="hintCount">0</b></div>
            <div class="stat-item">剩餘: <b id="remainingCells">81</b></div>
        </div>
        
        <div class="sudoku-container">
            <div class="sudoku-grid" id="grid">
                <!-- 由 JS 生成 -->
            </div>
        </div>
        
        <div class="numpad">
            <button class="num-btn" data-num="1">1</button>
            <button class="num-btn" data-num="2">2</button>
            <button class="num-btn" data-num="3">3</button>
            <button class="num-btn" data-num="4">4</button>
            <button class="num-btn" data-num="5">5</button>
            <button class="num-btn" data-num="6">6</button>
            <button class="num-btn" data-num="7">7</button>
            <button class="num-btn" data-num="8">8</button>
            <button class="num-btn" data-num="9">9</button>
            <button class="num-btn num-btn-clear" id="clearBtn"><i class="fas fa-eraser"></i></button>
        </div>
        
        <div class="message-box" id="msgBox"></div>
    </div>

    <script>
        // --- 遊戲狀態變數 ---
        const STATE = {
            board: [],       // 當前盤面
            solution: [],    // 完整答案
            initial: [],     // 初始題目（不可變的）
            selected: null,  // {r, c}
            timer: 0,
            timerId: null,
            difficulty: 'easy',
            errors: 0,
            hints: 0,
            isActive: false
        };

        // --- DOM 元素 ---
        const UI = {
            grid: document.getElementById('grid'),
            timer: document.getElementById('timer'),
            error: document.getElementById('errorCount'),
            hint: document.getElementById('hintCount'),
            remaining: document.getElementById('remainingCells'),
            msgBox: document.getElementById('msgBox'),
            diffBtns: document.querySelectorAll('.difficulty-btn'),
            numBtns: document.querySelectorAll('.num-btn')
        };

        // --- 核心邏輯：數獨生成 ---
        function generateSudoku(difficulty) {
            // 1. 生成完整合法的數獨板
            const solution = Array(9).fill(0).map(() => Array(9).fill(0));
            solveBoard(solution);
            STATE.solution = solution;

            // 2. 根據難度挖洞
            let attempts = difficulty === 'easy' ? 30 : (difficulty === 'normal' ? 45 : 55);
            
            const board = JSON.parse(JSON.stringify(solution));
            while (attempts > 0) {
                let r = Math.floor(Math.random() * 9);
                let c = Math.floor(Math.random() * 9);
                if (board[r][c] !== 0) {
                    board[r][c] = 0;
                    attempts--;
                }
            }
            
            STATE.initial = JSON.parse(JSON.stringify(board)); // 複製一份作為初始狀態
            STATE.board = JSON.parse(JSON.stringify(board));
        }

        // 遞迴回溯求解
        function solveBoard(board) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0) {
                        const nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
                        for (let num of nums) {
                            if (isValid(board, r, c, num)) {
                                board[r][c] = num;
                                if (solveBoard(board)) return true;
                                board[r][c] = 0;
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function isValid(board, r, c, num) {
            // 檢查行列
            for (let i = 0; i < 9; i++) {
                if (board[r][i] === num || board[i][c] === num) return false;
            }
            // 檢查九宮格
            let startR = Math.floor(r/3)*3, startC = Math.floor(c/3)*3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[startR+i][startC+j] === num) return false;
                }
            }
            return true;
        }

        // --- 遊戲控制 ---
        function initGame() {
            clearInterval(STATE.timerId);
            STATE.timer = 0;
            STATE.errors = 0;
            STATE.hints = 0;
            STATE.isActive = true;
            STATE.selected = null;
            
            generateSudoku(STATE.difficulty);
            updateTimer();
            updateStats();
            renderGrid();
            showMessage('遊戲開始！填入數字 1-9', 'info');
            
            STATE.timerId = setInterval(() => {
                STATE.timer++;
                updateTimer();
            }, 1000);
        }

        function selectCell(r, c) {
            STATE.selected = {r, c};
            
            // 更新 UI 樣式
            const cells = document.querySelectorAll('.sudoku-cell');
            cells.forEach(cell => {
                cell.classList.remove('selected', 'highlight', 'same-number');
                const cr = parseInt(cell.dataset.r);
                const cc = parseInt(cell.dataset.c);
                
                // 高亮相關行列宮格
                if (cr === r || cc === c || isSameBox(cr, cc, r, c)) {
                    cell.classList.add('highlight');
                }
            });

            // 高亮相同數字
            const val = STATE.board[r][c];
            if (val !== 0) {
                cells.forEach(cell => {
                    if (parseInt(cell.textContent) === val) {
                        cell.classList.add('same-number');
                    }
                });
            }

            // 選中當前格子
            const current = document.querySelector(`.sudoku-cell[data-r="${r}"][data-c="${c}"]`);
            if(current) current.classList.add('selected');
        }

        function fillNumber(num) {
            if (!STATE.isActive || !STATE.selected) return;
            const {r, c} = STATE.selected;

            // 預設數字不可改
            if (STATE.initial[r][c] !== 0) {
                showMessage('預設數字無法修改', 'error');
                return;
            }

            STATE.board[r][c] = num;
            renderGrid(); // 重新渲染以更新顏色
            selectCell(r, c); // 保持選中狀態並更新高亮
            updateStats();

            // 即時檢查錯誤 (僅當填入數字時)
            if (num !== 0 && !isValidCheck(r, c, num)) {
                STATE.errors++;
                updateStats();
                const cell = document.querySelector(`.sudoku-cell[data-r="${r}"][data-c="${c}"]`);
                if(cell) cell.classList.add('error');
            }

            checkWin();
        }

        // 簡單的檢查當前填入是否違反規則（僅視覺檢查）
        function isValidCheck(r, c, num) {
            // 檢查當前格子在盤面上是否有重複
            for(let i=0; i<9; i++) {
                if(i!==c && STATE.board[r][i]===num) return false;
                if(i!==r && STATE.board[i][c]===num) return false;
            }
            // 九宮格
            let sr = Math.floor(r/3)*3, sc = Math.floor(c/3)*3;
            for(let i=0; i<3; i++){
                for(let j=0; j<3; j++){
                    if((sr+i!==r || sc+j!==c) && STATE.board[sr+i][sc+j]===num) return false;
                }
            }
            return true;
        }

        function checkBoard() {
            let hasError = false;
            document.querySelectorAll('.sudoku-cell').forEach(el => el.classList.remove('error'));
            
            for(let r=0; r<9; r++){
                for(let c=0; c<9; c++){
                    if(STATE.board[r][c] !== 0 && !isValidCheck(r, c, STATE.board[r][c])){
                        const cell = document.querySelector(`.sudoku-cell[data-r="${r}"][data-c="${c}"]`);
                        if(cell && STATE.initial[r][c] === 0) cell.classList.add('error');
                        hasError = true;
                    }
                }
            }
            if(hasError) showMessage('發現衝突的數字！', 'error');
            else showMessage('目前沒有明顯錯誤', 'success');
        }

        function giveHint() {
            if(!STATE.isActive) return;
            
            // 找空格
            let emptyCells = [];
            for(let r=0; r<9; r++) 
                for(let c=0; c<9; c++) 
                    if(STATE.board[r][c]===0) emptyCells.push({r,c});
            
            if(emptyCells.length===0) return;
            
            // 隨機填一個
            const {r, c} = emptyCells[Math.floor(Math.random()*emptyCells.length)];
            STATE.board[r][c] = STATE.solution[r][c];
            STATE.hints++;
            
            renderGrid();
            selectCell(r, c);
            updateStats();
            checkWin();
            showMessage(`提示：已填入正確數字`, 'info');
        }

        function checkWin() {
            // 檢查是否全滿且無錯誤
            for(let r=0; r<9; r++){
                for(let c=0; c<9; c++){
                    if(STATE.board[r][c] !== STATE.solution[r][c]) return;
                }
            }
            // 勝利
            STATE.isActive = false;
            clearInterval(STATE.timerId);
            showMessage(`恭喜！挑戰成功！用時 ${UI.timer.textContent}`, 'success');
            UI.grid.style.animation = "pulse 0.5s 3";
        }

        // --- 輔助函數 ---
        function renderGrid() {
            UI.grid.innerHTML = '';
            for(let r=0; r<9; r++){
                for(let c=0; c<9; c++){
                    const cell = document.createElement('div');
                    cell.className = 'sudoku-cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    
                    const val = STATE.board[r][c];
                    if(val !== 0) {
                        cell.textContent = val;
                        if(STATE.initial[r][c] !== 0) cell.classList.add('default');
                        else cell.classList.add('user');
                    }
                    
                    cell.addEventListener('click', () => selectCell(r, c));
                    UI.grid.appendChild(cell);
                }
            }
        }

        function isSameBox(r1, c1, r2, c2) {
            return Math.floor(r1/3) === Math.floor(r2/3) && Math.floor(c1/3) === Math.floor(c2/3);
        }

        function updateTimer() {
            const m = Math.floor(STATE.timer / 60).toString().padStart(2, '0');
            const s = (STATE.timer % 60).toString().padStart(2, '0');
            UI.timer.textContent = `${m}:${s}`;
        }

        function updateStats() {
            UI.error.textContent = STATE.errors;
            UI.hint.textContent = STATE.hints;
            // 計算剩餘
            let count = 0;
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(STATE.board[r][c]===0) count++;
            UI.remaining.textContent = count;
        }

        function showMessage(text, type) {
            UI.msgBox.textContent = text;
            UI.msgBox.className = `message-box ${type}`;
            UI.msgBox.style.display = 'block';
            setTimeout(() => {
                UI.msgBox.style.display = 'none';
            }, 3000);
        }

        // --- 事件監聽 ---
        document.getElementById('newGameBtn').addEventListener('click', initGame);
        document.getElementById('checkBtn').addEventListener('click', checkBoard);
        document.getElementById('hintBtn').addEventListener('click', giveHint);
        document.getElementById('clearBtn').addEventListener('click', () => fillNumber(0));
        
        UI.diffBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                UI.diffBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                STATE.difficulty = btn.dataset.diff;
                initGame();
            });
        });

        UI.numBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const num = btn.dataset.num;
                fillNumber(num ? parseInt(num) : 0);
            });
        });

        // 鍵盤操作
        document.addEventListener('keydown', (e) => {
            if(!STATE.isActive) return;
            
            // 數字鍵
            if(e.key >= '1' && e.key <= '9') fillNumber(parseInt(e.key));
            if(e.key === 'Backspace' || e.key === 'Delete') fillNumber(0);

            // 方向鍵 (移動選擇 - 允許移到預設數字)
            if(STATE.selected) {
                let {r, c} = STATE.selected;
                if(e.key === 'ArrowUp') r = Math.max(0, r-1);
                if(e.key === 'ArrowDown') r = Math.min(8, r+1);
                if(e.key === 'ArrowLeft') c = Math.max(0, c-1);
                if(e.key === 'ArrowRight') c = Math.min(8, c+1);
                selectCell(r, c);
            }
        });

        // 啟動遊戲
        initGame();
    </script>
</body>
</html>