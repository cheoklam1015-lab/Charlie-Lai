<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數獨遊戲</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .difficulty-btn {
            padding: 10px 20px;
            font-size: 1rem;
            border: 2px solid #3498db;
            background-color: white;
            color: #3498db;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .difficulty-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .difficulty-btn:hover:not(.active) {
            background-color: #f0f7ff;
        }
        
        .game-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .timer-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            background-color: #f8f9fa;
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .timer {
            font-family: 'Courier New', monospace;
            color: #3498db;
        }
        
        .controls {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-new-game {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-check {
            background-color: #3498db;
            color: white;
        }
        
        .btn-hint {
            background-color: #f39c12;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .sudoku-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 1px;
            background-color: #333;
            border: 3px solid #333;
            width: 450px;
            height: 450px;
        }
        
        .sudoku-cell {
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .sudoku-cell:hover {
            background-color: #f0f7ff;
        }
        
        .sudoku-cell.selected {
            background-color: #e1f0ff;
            box-shadow: inset 0 0 0 2px #3498db;
        }
        
        .sudoku-cell.default {
            color: #000000;
            font-weight: 800;
        }
        
        .sudoku-cell.user {
            color: #3498db;
        }
        
        .sudoku-cell.error {
            background-color: #ffebee;
            color: #e74c3c;
        }
        
        .sudoku-cell.highlight {
            background-color: #f0f8ff;
        }
        
        .sudoku-cell.same-number {
            background-color: #e8f5e9 !important;
        }
        
        /* 添加3x3網格邊框 */
        .sudoku-cell:nth-child(3n) {
            border-right: 2px solid #333;
        }
        
        .sudoku-cell:nth-child(9n+1) {
            border-left: 2px solid #333;
        }
        
        .sudoku-cell:nth-child(n+19):nth-child(-n+27),
        .sudoku-cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #333;
        }
        
        .sudoku-cell:nth-child(n+1):nth-child(-n+9) {
            border-top: 2px solid #333;
        }
        
        .sudoku-cell:nth-child(n+73):nth-child(-n+81) {
            border-bottom: 2px solid #333;
        }
        
        /* 數字選擇器 */
        .number-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 30px;
        }
        
        .number-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #3498db;
            background-color: white;
            color: #3498db;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .number-btn:hover {
            background-color: #3498db;
            color: white;
        }
        
        .number-btn.active-number {
            background-color: #3498db;
            color: white;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .number-btn:active {
            transform: scale(0.95);
        }
        
        .btn-clear {
            background-color: #e74c3c;
            color: white;
            border: 2px solid #e74c3c;
        }
        
        .btn-clear:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        
        /* 訊息提示 */
        .message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            display: none;
        }
        
        .message.error {
            background-color: #ffebee;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            display: block;
        }
        
        .message.success {
            background-color: #e8f5e9;
            color: #2ecc71;
            border: 1px solid #2ecc71;
            display: block;
        }
        
        .message.info {
            background-color: #e3f2fd;
            color: #3498db;
            border: 1px solid #3498db;
            display: block;
        }
        
        /* 遊戲說明 */
        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            border: 1px solid #e0e0e0;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 10px;
            color: #555;
        }
        
        .color-example {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* 完成動畫 */
        @keyframes celebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .celebrate {
            animation: celebration 0.5s ease 3;
        }
        
        /* 當前選擇的數字提示 */
        .current-number-hint {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #3498db;
            font-weight: bold;
            min-height: 1.5rem;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .sudoku-grid {
                width: 360px;
                height: 360px;
            }
            
            .sudoku-cell {
                font-size: 20px;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .sudoku-grid {
                width: 315px;
                height: 315px;
            }
            
            .sudoku-cell {
                font-size: 18px;
            }
            
            .number-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 0.9rem;
            }
            
            .difficulty-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .difficulty-btn {
                width: 150px;
            }
        }
        
        /* 難度指示器 */
        .difficulty-indicator {
            text-align: center;
            margin-top: 10px;
            font-size: 1rem;
            color: #7f8c8d;
        }
        
        .current-difficulty {
            color: #2c3e50;
            font-weight: bold;
        }
        
        /* 統計資訊 */
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .stat-item {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>數獨遊戲</h1>
            <p class="subtitle">經典數字邏輯遊戲 - 選擇您的難度</p>
            
            <div class="difficulty-selector">
                <button class="difficulty-btn active" data-difficulty="easy">簡易模式</button>
                <button class="difficulty-btn" data-difficulty="normal">中級模式</button>
            </div>
            
            <div class="difficulty-indicator">
                當前難度：<span class="current-difficulty" id="currentDifficulty">簡易模式</span>
                <div class="stats">
                    <div class="stat-item">預設數字：<span id="prefilledCount">45</span></div>
                    <div class="stat-item">空格數量：<span id="emptyCount">36</span></div>
                </div>
            </div>
        </header>
        
        <div class="game-controls">
            <div class="timer-container">
                <i class="far fa-clock"></i>
                <span class="timer" id="timer">00:00</span>
            </div>
            
            <div class="controls">
                <button class="btn btn-new-game" id="newGameBtn">
                    <i class="fas fa-plus-circle"></i> 新遊戲
                </button>
                <button class="btn btn-check" id="checkBtn">
                    <i class="fas fa-check-circle"></i> 檢查
                </button>
                <button class="btn btn-hint" id="hintBtn">
                    <i class="fas fa-lightbulb"></i> 提示
                <button class="btn btn-reset" id="Frontpage">
                    <a href="index.html">返回主頁</a> 
                </button>
            </div>
        </div>
        
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">剩餘空格</div>
                <div class="info-value" id="remainingCells">45</div>
            </div>
            <div class="info-item">
                <div class="info-label">錯誤次數</div>
                <div class="info-value" id="errorCount">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">提示次數</div>
                <div class="info-value" id="hintCount">0</div>
            </div>
        </div>
        
        <div class="current-number-hint" id="currentNumberHint"></div>
        
        <div class="sudoku-container">
            <div class="sudoku-grid" id="sudokuGrid">
                <!-- 數獨格子將由JavaScript動態生成 -->
            </div>
        </div>
        
        <div class="number-selector">
            <button class="number-btn" data-number="1">1</button>
            <button class="number-btn" data-number="2">2</button>
            <button class="number-btn" data-number="3">3</button>
            <button class="number-btn" data-number="4">4</button>
            <button class="number-btn" data-number="5">5</button>
            <button class="number-btn" data-number="6">6</button>
            <button class="number-btn" data-number="7">7</button>
            <button class="number-btn" data-number="8">8</button>
            <button class="number-btn" data-number="9">9</button>
            <button class="number-btn btn-clear" id="clearBtn">
                <i class="fas fa-eraser"></i>
            </button>
        </div>
        
        <div class="message" id="message"></div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 遊戲說明</h3>
            <ul>
                <li>
                    <span class="color-example" style="background-color: #000000;"></span>
                    <strong>黑色數字</strong>：遊戲預設數字，不可更改
                </li>
                <li>
                    <span class="color-example" style="background-color: #3498db;"></span>
                    <strong>藍色數字</strong>：玩家填入的數字
                </li>
                <li>
                    <span class="color-example" style="background-color: #e74c3c;"></span>
                    <strong>紅色數字</strong>：錯誤的數字（違反數獨規則）
                </li>
                <li>
                    <span class="color-example" style="background-color: #e8f5e9;"></span>
                    <strong>綠色背景</strong>：相同數字的格子（包含預設和玩家填入）
                </li>
                <li><strong>遊戲規則</strong>：每行、每列和每個3x3小九宮格都必須包含1-9的數字，且不能重複</li>
                <li><strong>操作方式</strong>：點選空格，然後點擊上方數字按鈕填入數字，或使用鍵盤數字鍵1-9</li>
                <li><strong>提示功能</strong>：當您點擊數字按鈕時，所有相同數字（包含預設數字和玩家填入數字）會以綠色背景高亮顯示</li>
            </ul>
        </div>
    </div>

    <script>
        // 遊戲變數
        let sudokuBoard = []; // 完整的數獨答案
        let gameBoard = [];   // 當前遊戲盤面（包含預設數字和玩家輸入）
        let initialBoard = []; // 初始盤面（預設數字）
        let selectedCell = null; // 當前選中的格子
        let timer = 0; // 遊戲時間（秒）
        let timerInterval = null; // 計時器間隔
        let errorCount = 0; // 錯誤次數
        let hintCount = 0; // 提示次數
        let gameActive = false; // 遊戲是否進行中
        let currentDifficulty = 'easy'; // 當前難度
        let currentSelectedNumber = null; // 當前選中的數字（用於高亮）
        
        // DOM元素
        const sudokuGrid = document.getElementById('sudokuGrid');
        const timerElement = document.getElementById('timer');
        const remainingCellsElement = document.getElementById('remainingCells');
        const errorCountElement = document.getElementById('errorCount');
        const hintCountElement = document.getElementById('hintCount');
        const messageElement = document.getElementById('message');
        const newGameBtn = document.getElementById('newGameBtn');
        const checkBtn = document.getElementById('checkBtn');
        const hintBtn = document.getElementById('hintBtn');
        const clearBtn = document.getElementById('clearBtn');
        const numberButtons = document.querySelectorAll('.number-btn[data-number]');
        const currentNumberHint = document.getElementById('currentNumberHint');
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const currentDifficultyElement = document.getElementById('currentDifficulty');
        const prefilledCountElement = document.getElementById('prefilledCount');
        const emptyCountElement = document.getElementById('emptyCount');
        
        // 生成完整的數獨答案
        function generateSudokuSolution() {
            // 創建一個空的9x9數獨板
            const board = Array(9).fill().map(() => Array(9).fill(0));
            
            // 使用遞歸回溯算法生成數獨
            solveSudoku(board);
            
            return board;
        }
        
        // 解決數獨（遞歸回溯算法）
        function solveSudoku(board) {
            const empty = findEmptyLocation(board);
            
            // 如果沒有空格，表示數獨已解決
            if (!empty) {
                return true;
            }
            
            const [row, col] = empty;
            
            // 隨機排列數字1-9，增加多樣性
            const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            shuffleArray(numbers);
            
            for (let num of numbers) {
                if (isValid(board, row, col, num)) {
                    board[row][col] = num;
                    
                    if (solveSudoku(board)) {
                        return true;
                    }
                    
                    board[row][col] = 0; // 回溯
                }
            }
            
            return false; // 觸發回溯
        }
        
        // 尋找空格位置
        function findEmptyLocation(board) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0) {
                        return [row, col];
                    }
                }
            }
            return null; // 沒有空格
        }
        
        // 檢查數字是否有效
        function isValid(board, row, col, num) {
            // 檢查同一行
            for (let x = 0; x < 9; x++) {
                if (board[row][x] === num) {
                    return false;
                }
            }
            
            // 檢查同一列
            for (let x = 0; x < 9; x++) {
                if (board[x][col] === num) {
                    return false;
                }
            }
            
            // 檢查3x3小九宮格
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[startRow + i][startCol + j] === num) {
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        // 打亂陣列順序
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // 根據難度生成初始盤面（隱藏部分數字）
        function generateInitialBoard(solution, difficulty) {
            const board = JSON.parse(JSON.stringify(solution));
            
            // 簡易模式保留45個數字，中級模式保留35個數字
            const cellsToKeep = difficulty === 'easy' ? 45 : 35;
            const cellsToRemove = 81 - cellsToKeep;
            
            // 隨機選擇要隱藏的格子
            const positions = [];
            
            // 生成所有位置
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    positions.push({ row, col });
                }
            }
            
            // 隨機打亂位置
            shuffleArray(positions);
            
            // 隱藏指定數量的格子
            for (let i = 0; i < cellsToRemove && i < positions.length; i++) {
                const { row, col } = positions[i];
                board[row][col] = 0;
            }
            
            // 更新統計資訊
            prefilledCountElement.textContent = cellsToKeep;
            emptyCountElement.textContent = cellsToRemove;
            
            return board;
        }
        
        // 初始化遊戲
        function initGame() {
            // 生成完整的數獨答案
            sudokuBoard = generateSudokuSolution();
            
            // 生成初始盤面（隱藏部分數字）
            initialBoard = generateInitialBoard(sudokuBoard, currentDifficulty);
            gameBoard = JSON.parse(JSON.stringify(initialBoard));
            
            // 重置遊戲狀態
            selectedCell = null;
            timer = 0;
            errorCount = 0;
            hintCount = 0;
            gameActive = true;
            currentSelectedNumber = null;
            
            // 更新UI
            updateTimer();
            updateGameInfo();
            clearMessage();
            currentNumberHint.textContent = "";
            
            // 重置數字按鈕狀態
            numberButtons.forEach(btn => btn.classList.remove('active-number'));
            
            // 停止現有計時器
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // 開始新計時器
            timerInterval = setInterval(() => {
                timer++;
                updateTimer();
            }, 1000);
            
            // 渲染數獨網格
            renderSudokuGrid();
            
            showMessage(`遊戲開始！${currentDifficulty === 'easy' ? '簡易' : '中級'}模式，請填寫空格中的數字。`, "info");
        }
        
        // 渲染數獨網格
        function renderSudokuGrid() {
            sudokuGrid.innerHTML = '';
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'sudoku-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // 設定格子內容
                    const value = gameBoard[row][col];
                    if (value !== 0) {
                        cell.textContent = value;
                        
                        // 如果是預設數字（黑色），否則是用戶輸入的數字（藍色）
                        if (initialBoard[row][col] !== 0) {
                            cell.classList.add('default');
                        } else {
                            cell.classList.add('user');
                        }
                        
                        // 如果當前選中了某個數字，且這個格子的數字與之相同，則高亮顯示
                        if (currentSelectedNumber === value) {
                            cell.classList.add('same-number');
                        }
                    }
                    
                    // 添加點擊事件
                    cell.addEventListener('click', () => selectCell(row, col));
                    
                    sudokuGrid.appendChild(cell);
                }
            }
            
            // 更新剩餘空格數量
            updateRemainingCells();
        }
        
        // 選擇格子
        function selectCell(row, col) {
            // 如果點擊的是預設數字，則不選中
            if (initialBoard[row][col] !== 0) {
                return;
            }
            
            // 移除之前選中格子的樣式
            if (selectedCell) {
                const prevCell = document.querySelector(
                    `.sudoku-cell[data-row="${selectedCell.row}"][data-col="${selectedCell.col}"]`
                );
                if (prevCell) {
                    prevCell.classList.remove('selected');
                    
                    // 移除相關格子的高亮
                    removeHighlights();
                }
            }
            
            // 設定新的選中格子
            selectedCell = { row, col };
            const cell = document.querySelector(
                `.sudoku-cell[data-row="${row}"][data-col="${col}"]`
            );
            cell.classList.add('selected');
            
            // 高亮相關格子（同一行、同一列、同一小九宮格）
            highlightRelatedCells(row, col);
            
            // 顯示當前選擇的數字提示
            const currentValue = gameBoard[row][col];
            if (currentValue !== 0) {
                currentNumberHint.textContent = `當前選中：第${row+1}行，第${col+1}列，數字 ${currentValue}`;
            } else {
                currentNumberHint.textContent = `當前選中：第${row+1}行，第${col+1}列`;
            }
        }
        
        // 高亮相關格子
        function highlightRelatedCells(row, col) {
            // 清除所有高亮
            removeHighlights();
            
            // 高亮同一行
            for (let c = 0; c < 9; c++) {
                const cell = document.querySelector(
                    `.sudoku-cell[data-row="${row}"][data-col="${c}"]`
                );
                if (cell && !cell.classList.contains('selected')) {
                    cell.classList.add('highlight');
                }
            }
            
            // 高亮同一列
            for (let r = 0; r < 9; r++) {
                const cell = document.querySelector(
                    `.sudoku-cell[data-row="${r}"][data-col="${col}"]`
                );
                if (cell && !cell.classList.contains('selected')) {
                    cell.classList.add('highlight');
                }
            }
            
            // 高亮同一小九宮格
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            
            for (let r = startRow; r < startRow + 3; r++) {
                for (let c = startCol; c < startCol + 3; c++) {
                    const cell = document.querySelector(
                        `.sudoku-cell[data-row="${r}"][data-col="${c}"]`
                    );
                    if (cell && !cell.classList.contains('selected')) {
                        cell.classList.add('highlight');
                    }
                }
            }
        }
        
        // 高亮所有相同數字的格子
        function highlightSameNumbers(number) {
            // 清除之前的相同數字高亮
            const sameNumberCells = document.querySelectorAll('.sudoku-cell.same-number');
            sameNumberCells.forEach(cell => {
                cell.classList.remove('same-number');
            });
            
            // 如果數字為0，則不清除
            if (number === 0) return;
            
            // 高亮所有相同數字的格子（包含預設數字和玩家填入的數字）
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameBoard[row][col] === number) {
                        const cell = document.querySelector(
                            `.sudoku-cell[data-row="${row}"][data-col="${col}"]`
                        );
                        if (cell) {
                            cell.classList.add('same-number');
                        }
                    }
                }
            }
        }
        
        // 移除所有高亮
        function removeHighlights() {
            const highlightedCells = document.querySelectorAll('.sudoku-cell.highlight');
            highlightedCells.forEach(cell => {
                cell.classList.remove('highlight');
            });
        }
        
        // 在選中的格子中填入數字
        function fillNumber(number) {
            if (!gameActive || !selectedCell) {
                showMessage("請先選擇一個格子！", "error");
                return;
            }
            
            const { row, col } = selectedCell;
            
            // 如果選中的是預設數字，則不允許更改
            if (initialBoard[row][col] !== 0) {
                showMessage("預設數字不可更改！", "error");
                return;
            }
            
            // 檢查數字是否有效（不與同一行、列、小九宮格衝突）
            const isValid = checkNumberValidity(row, col, number);
            
            // 更新遊戲盤面
            gameBoard[row][col] = number;
            
            // 更新UI
            const cell = document.querySelector(
                `.sudoku-cell[data-row="${row}"][data-col="${col}"]`
            );
            cell.textContent = number === 0 ? '' : number;
            cell.classList.add('user');
            
            // 根據有效性設置樣式
            if (number !== 0 && !isValid) {
                cell.classList.add('error');
                errorCount++;
                errorCountElement.textContent = errorCount;
                showMessage(`數字 ${number} 在此位置無效！請檢查同一行、列和小九宮格。`, "error");
            } else {
                cell.classList.remove('error');
            }
            
            // 如果填入了數字，則高亮所有相同數字的格子
            if (number !== 0) {
                highlightSameNumbers(number);
                currentSelectedNumber = number;
                
                // 更新數字按鈕狀態
                numberButtons.forEach(btn => {
                    if (parseInt(btn.dataset.number) === number) {
                        btn.classList.add('active-number');
                    } else {
                        btn.classList.remove('active-number');
                    }
                });
            } else {
                // 如果清除了數字，則清除高亮
                highlightSameNumbers(0);
                currentSelectedNumber = null;
                
                // 清除數字按鈕的活動狀態
                numberButtons.forEach(btn => btn.classList.remove('active-number'));
            }
            
            // 更新剩餘空格數量
            updateRemainingCells();
            
            // 更新當前數字提示
            if (number !== 0) {
                currentNumberHint.textContent = `當前選中：第${row+1}行，第${col+1}列，數字 ${number}`;
            } else {
                currentNumberHint.textContent = `當前選中：第${row+1}行，第${col+1}列`;
            }
            
            // 檢查遊戲是否完成
            checkGameCompletion();
        }
        
        // 檢查數字有效性
        function checkNumberValidity(row, col, number) {
            if (number === 0) return true; // 清除數字總是有效的
            
            // 檢查同一行
            for (let c = 0; c < 9; c++) {
                if (c !== col && gameBoard[row][c] === number) {
                    return false;
                }
            }
            
            // 檢查同一列
            for (let r = 0; r < 9; r++) {
                if (r !== row && gameBoard[r][col] === number) {
                    return false;
                }
            }
            
            // 檢查同一小九宮格
            const startRow = Math.floor(row / 3) * 3;
            const startCol = Math.floor(col / 3) * 3;
            
            for (let r = startRow; r < startRow + 3; r++) {
                for (let c = startCol; c < startCol + 3; c++) {
                    if (r !== row && c !== col && gameBoard[r][c] === number) {
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        // 檢查整個遊戲板
        function checkBoard() {
            let hasErrors = false;
            
            // 清除所有錯誤標記
            const errorCells = document.querySelectorAll('.sudoku-cell.error');
            errorCells.forEach(cell => {
                cell.classList.remove('error');
            });
            
            // 檢查每個格子
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const value = gameBoard[row][col];
                    
                    if (value !== 0) {
                        // 檢查數字是否有效
                        const isValid = checkNumberValidity(row, col, value);
                        
                        if (!isValid && initialBoard[row][col] === 0) {
                            const cell = document.querySelector(
                                `.sudoku-cell[data-row="${row}"][data-col="${col}"]`
                            );
                            cell.classList.add('error');
                            hasErrors = true;
                        }
                    }
                }
            }
            
            if (hasErrors) {
                showMessage("發現錯誤！請檢查紅色標記的格子。", "error");
            } else {
                showMessage("恭喜！目前沒有發現錯誤。", "success");
            }
        }
        
        // 提供提示
        function giveHint() {
            if (!gameActive) {
                showMessage("遊戲尚未開始！", "error");
                return;
            }
            
            // 尋找一個空白的格子
            let emptyCells = [];
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameBoard[row][col] === 0) {
                        emptyCells.push({ row, col });
                    }
                }
            }
            
            if (emptyCells.length === 0) {
                showMessage("沒有空白的格子了！", "info");
                return;
            }
            
            // 隨機選擇一個空白格子
            const randomIndex = Math.floor(Math.random() * emptyCells.length);
            const { row, col } = emptyCells[randomIndex];
            
            // 填入正確答案
            const correctValue = sudokuBoard[row][col];
            gameBoard[row][col] = correctValue;
            
            // 更新UI
            const cell = document.querySelector(
                `.sudoku-cell[data-row="${row}"][data-col="${col}"]`
            );
            cell.textContent = correctValue;
            cell.classList.add('user');
            
            // 添加提示動畫
            cell.classList.add('celebrate');
            setTimeout(() => {
                cell.classList.remove('celebrate');
            }, 1500);
            
            // 更新計數器
            hintCount++;
            hintCountElement.textContent = hintCount;
            
            // 更新剩餘空格數量
            updateRemainingCells();
            
            showMessage(`提示：第${row+1}行，第${col+1}列的數字是 ${correctValue}`, "info");
            
            // 檢查遊戲是否完成
            checkGameCompletion();
        }
        
        // 檢查遊戲是否完成
        function checkGameCompletion() {
            // 檢查是否所有格子都已填寫
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameBoard[row][col] === 0) {
                        return false; // 還有空格，遊戲未完成
                    }
                }
            }
            
            // 檢查是否所有數字都正確
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameBoard[row][col] !== sudokuBoard[row][col]) {
                        return false; // 有錯誤答案
                    }
                }
            }
            
            // 遊戲完成！
            gameActive = false;
            clearInterval(timerInterval);
            
            // 顯示完成訊息
            showMessage(`恭喜！您完成了數獨遊戲！用時 ${formatTime(timer)}，錯誤 ${errorCount} 次，提示 ${hintCount} 次。`, "success");
            
            // 慶祝動畫
            const cells = document.querySelectorAll('.sudoku-cell');
            cells.forEach((cell, index) => {
                setTimeout(() => {
                    cell.classList.add('celebrate');
                }, index * 20);
                
                setTimeout(() => {
                    cell.classList.remove('celebrate');
                }, 2000 + index * 20);
            });
            
            return true;
        }
        
        // 更新計時器顯示
        function updateTimer() {
            timerElement.textContent = formatTime(timer);
        }
        
        // 格式化時間為 MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
        
        // 更新遊戲資訊
        function updateGameInfo() {
            errorCountElement.textContent = errorCount;
            hintCountElement.textContent = hintCount;
            updateRemainingCells();
        }
        
        // 更新剩餘空格數量
        function updateRemainingCells() {
            let emptyCount = 0;
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameBoard[row][col] === 0) {
                        emptyCount++;
                    }
                }
            }
            remainingCellsElement.textContent = emptyCount;
        }
        
        // 顯示訊息
        function showMessage(text, type) {
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            
            // 3秒後自動清除訊息（成功訊息保持較久）
            const timeout = type === 'success' ? 5000 : 3000;
            setTimeout(clearMessage, timeout);
        }
        
        // 清除訊息
        function clearMessage() {
            messageElement.textContent = '';
            messageElement.className = 'message';
        }
        
        // 變更難度
        function changeDifficulty(difficulty) {
            currentDifficulty = difficulty;
            currentDifficultyElement.textContent = difficulty === 'easy' ? '簡易模式' : '中級模式';
            
            // 更新難度按鈕狀態
            difficultyButtons.forEach(btn => {
                if (btn.dataset.difficulty === difficulty) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 開始新遊戲
            initGame();
        }
        
        // 事件監聽器
        newGameBtn.addEventListener('click', initGame);
        
        checkBtn.addEventListener('click', checkBoard);
        
        hintBtn.addEventListener('click', giveHint);
        
        clearBtn.addEventListener('click', () => {
            if (selectedCell) {
                fillNumber(0); // 0 表示清除數字
            }
        });
        
        // 數字按鈕事件
        numberButtons.forEach(button => {
            button.addEventListener('click', () => {
                const number = parseInt(button.dataset.number);
                fillNumber(number);
            });
        });
        
        // 難度選擇按鈕事件
        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const difficulty = button.dataset.difficulty;
                if (difficulty !== currentDifficulty) {
                    changeDifficulty(difficulty);
                }
            });
        });
        
        // 鍵盤事件
        document.addEventListener('keydown', (event) => {
            if (!gameActive) return;
            
            // 數字鍵 1-9 填入數字
            if (event.key >= '1' && event.key <= '9') {
                const number = parseInt(event.key);
                fillNumber(number);
            }
            
            // 退格鍵或刪除鍵清除數字
            if (event.key === 'Backspace' || event.key === 'Delete') {
                if (selectedCell) {
                    fillNumber(0);
                }
            }
            
            // 方向鍵移動選中的格子
            if (selectedCell) {
                let { row, col } = selectedCell;
                
                switch (event.key) {
                    case 'ArrowUp':
                        row = Math.max(0, row - 1);
                        break;
                    case 'ArrowDown':
                        row = Math.min(8, row + 1);
                        break;
                    case 'ArrowLeft':
                        col = Math.max(0, col - 1);
                        break;
                    case 'ArrowRight':
                        col = Math.min(8, col + 1);
                        break;
                }
                
                // 如果新位置不是預設數字，則選中它
                if (initialBoard[row][col] === 0) {
                    selectCell(row, col);
                }
            }
        });
        
        // 初始化遊戲
        initGame();
    </script>
    
    <!-- Font Awesome 圖標 -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>